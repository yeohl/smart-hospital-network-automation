import json
import logging
import urllib3

logger = logging.getLogger()
logger.setLevel(logging.INFO)

http = urllib3.PoolManager()

SLACK_WEBHOOK_URL = "https://hooks.slack.com/services/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"

def notify_slack(text: str) -> None:
    try:
        resp = http.request(
            "POST",
            SLACK_WEBHOOK_URL,
            body=json.dumps({"text": text}).encode(),
            headers={"Content-Type": "application/json"},
        )
        logger.info(f"[Slack] ì „ì†¡ OK ({resp.status})")
    except Exception as e:
        logger.error(f"[Slack] ì „ì†¡ ì‹¤íŒ¨: {e}")


def extract_instance_id_from_alarm(alarm_name: str) -> str:
    mapping = {
        "WARD-A_i-a1_HealthCheck": "i-0b63747b3d1f52972",
        "WARD-A_i-a2_HealthCheck": "i-0fd919c3aa8dea3e9",
        "WARD-B_i-b1_HealthCheck": "i-045763e17c20e1b8a",
        "WARD-B_i-b2_HealthCheck": "i-0a868727c52163cf1",
        "WARD-C_i-c1_HealthCheck": "i-0cdf03f03f0353f3f",
        "WARD-C_i-c2_HealthCheck": "i-056a592094da69fe6",
    }
    return mapping.get(alarm_name, "Unknown")


INSTANCE_TO_WARD = {
    "i-0b63747b3d1f52972": "A", "i-0fd919c3aa8dea3e9": "A",
    "i-045763e17c20e1b8a": "B", "i-0a868727c52163cf1": "B",
    "i-0cdf03f03f0353f3f": "C", "i-056a592094da69fe6": "C",
}

def lambda_handler(event, context):
    logger.info("=== EVENT ===")
    logger.info(json.dumps(event))

    # CloudWatch â†’ SNS ê¸°ë°˜ ì¥ì• 
    if event.get("Records", [{}])[0].get("EventSource") == "aws:sns":
        try:
            msg = json.loads(event["Records"][0]["Sns"]["Message"])
            alarm = msg.get("AlarmName", "Unknown")
            inst_id = extract_instance_id_from_alarm(alarm)
            ward = INSTANCE_TO_WARD.get(inst_id, "Unknown")

            notify_slack(
                f"ğŸš¨ *ë„¤íŠ¸ì›Œí¬ ì¥ì•  ê°ì§€!*\n"
                f"ğŸ¥ ë³‘ë™: `{ward}`\n"
                f"ì¥ì•  ì˜ë£Œê¸°ê¸°: `{alarm}`\n"
                f"ì¸ìŠ¤í„´ìŠ¤ ID: `{inst_id}`"
            )
        except Exception as e:
            logger.error(f"SNS íŒŒì‹± ì‹¤íŒ¨: {e}")
            return {"statusCode": 500, "body": "SNS ì²˜ë¦¬ ì˜¤ë¥˜"}

    # CloudTrail â†’ StopInstances ê¸°ë°˜
    elif event.get("source") == "aws.ec2":
        try:
            detail = event["detail"]
            #evt_name = detail.get("eventName", "Unknown")
            alarm = msg.get("AlarmName", "Unknown")
            inst_id = extract_instance_id_from_alarm(alarm)
            inst_id = (
                detail.get("requestParameters", {})
                .get("instancesSet", {})
                .get("items", [{}])[0]
                .get("instanceId", "Unknown")
            )
            ward = INSTANCE_TO_WARD.get(inst_id, "Unknown")

            notify_slack(
                f"âš ï¸ *ì˜ë£Œê¸°ê¸° ì¥ì•  ê°ì§€!*\n"
                #f"ì´ë²¤íŠ¸: `{evt_name}`\n"
                f"ğŸ¥ ë³‘ë™: `{ward}`\n"
                f"ì¥ì•  ì˜ë£Œê¸°ê¸°: `{alarm}`"
                
            )

        except Exception as e:
            logger.error(f"CloudTrail íŒŒì‹± ì‹¤íŒ¨: {e}")
            return {"statusCode": 500, "body": "CloudTrail ì²˜ë¦¬ ì˜¤ë¥˜"}

   
    elif event.get("type") == "ROUTE_RECOVERY":
        inst_id = event.get("instance_id", "Unknown")
        eni_id = event.get("eni_id", "Unknown")
        status = event.get("status", "Unknown")
        #triggered_by = event.get("triggered_by", "lambda")
        ward = INSTANCE_TO_WARD.get(inst_id, "Unknown")
        emoji = "âœ…" if status == "SUCCESS" else "âŒ"

        notify_slack(
            f"{emoji} *ì¡°ì¹˜ ê²°ê³¼ ({status})*\n"
            f"ğŸ¥ ë³‘ë™: `{ward}`\n"
            f"ğŸ” `{inst_id}` â†’ `{eni_id}`\n"
            #f"ğŸ“¡ íŠ¸ë¦¬ê±°: `{triggered_by}`"
        )

    else:
        logger.warning("ì§€ì›í•˜ì§€ ì•ŠëŠ” ì´ë²¤íŠ¸ í˜•ì‹")
        return {"statusCode": 400, "body": "Unsupported event"}

    return {"statusCode": 200, "body": "Slack ì•Œë¦¼ ì™„ë£Œ"}
